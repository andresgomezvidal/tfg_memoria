%done="$(\grep -oh 'ref{lst:\w*}' *.tex | cut -d '{' -f2 | tr '\n' '|')"; \grep -oh 'label={lst:\w*}' code-configuration.tex | \grep -vE "${done:0:-1}"

\chapter{Programming and configuration code}
%\lstinputlisting[style=xml,caption=,captionpos=b]{src/}
%\lstinputlisting[style=PS,caption=,captionpos=b]{src/}

\section*{Detection of the use of the TGT with klist}
\lstinputlisting[style=xml,caption=Remote command configuration in \textit{/var/ossec/etc/shared/default/agent.conf} for the klist script,captionpos=b,label={lst:klist_wodle}]{src/klist_wodle.xml}
\linej
\lstinputlisting[style=PS,caption=Script to scan and parse to JSON the tickets in the cache,captionpos=b,label={lst:klist}]{src/klist.ps1}
\linej
\lstinputlisting[style=PS,caption=Way to get the MaxTicketAge from the Group Policy,captionpos=b,label={lst:klist_getMaxTicketAge}]{src/report.ps1}
\linej

\section*{Detection of suspicious logins}
\lstinputlisting[style=PS,caption=Distributed brute force logins changing the ip address for the internal network,captionpos=b,label={lst:distributed_logins_winrs}]{src/distributed_logins_winrs.ps1}
\linej
\lstinputlisting[style=xml,caption=Wazuh rules for checking OU logins outside of usual hours,captionpos=b,label={lst:OU_rules}]{src/rules_OU.xml}
\linej
\lstinputlisting[style=xml,caption=Remote command configuration in \textit{/var/ossec/etc/shared/default/agent.conf} to find logins on unusual hours for the OU users,captionpos=b,label={lst:OU_wodle}]{src/OU_wodle.xml}
\linej
\lstinputlisting[style=PS,caption=Remote script to find logins on unusual hours for the OU users,captionpos=b,label={lst:OU}]{src/OU.ps1}
\linej

\section*{File monitoring}
\lstinputlisting[style=xml,caption=Windows Defender's Controlled Folder Access rules,captionpos=b,label={lst:windows_defender}]{src/rules_windows_defender.xml}
\linej
\lstinputlisting[style=xml,caption=Syscheck local configuration in the \textit{ossec.conf} file on the agent,captionpos=b,label={lst:syscheck_agent}]{src/syscheck_agent.xml}
\linej
\lstinputlisting[style=xml,caption=Syscheck rules for crypto ransomware detection,captionpos=b,label={lst:syscheck_rules}]{src/rules_syscheck.xml}
\linej
\lstinputlisting[style=xml,caption=Syscheck rules for crypto ransomware detection with more deletion events required,captionpos=b,label={lst:syscheck_rules_2}]{src/rules_syscheck_2.xml}
\linej
\lstinputlisting[style=xml,caption=Windows File Auditing rules for crypto ransomware detection,captionpos=b,label={lst:file_audit}]{src/rules_file_audit.xml}
\linej

\lstinputlisting[style=xml,caption=Wazuh rules for detecting encrypted files,captionpos=b,label={lst:trid_rules}]{src/trid/rules_trid.xml}
\linej
\lstinputlisting[style=xml,caption=Active response configuration in \textit{/var/ossec/etc/shared/default/agent.conf} for the Trid CMD,captionpos=b,label={lst:trid_ossec}]{src/trid/ossec.conf}
\linej
\lstinputlisting[style=PS,caption=CMD script only for executing the Trid PowerShell script,captionpos=b,label={lst:trid_cmd}]{src/trid/trid.cmd}
\linej
\lstinputlisting[style=PS,caption=PowerShell script that writes a Trid log entry for each modified file in the last 2 minutes in the folder,captionpos=b,label={lst:trid_ps1}]{src/trid/trid.ps1}
\linej

\section*{Registry monitoring and active response for Windows Defender}
\lstinputlisting[style=xml,caption=Sysmon rules for monitoring the Windows registry,captionpos=b,label={lst:sysmon_events_registry}]{src/registry/sysmon_events_registry.xml}
\linej
\lstinputlisting[style=xml,caption=Wazuh rules for registry monitoring,captionpos=b,label={lst:rules_registry}]{src/registry/rules_registry.xml}
\linej
\lstinputlisting[style=xml,caption=Configuration for 3 active response commands for registry rules in \textit{/var/ossec/etc/ossec.conf},captionpos=b,label={lst:active_response_registry}]{src/registry/active_response_registry.xml}
\linej
\lstinputlisting[style=PS,caption=CMD script only for executing another PowerShell script,captionpos=b,label={lst:change-registry-value_0}]{src/registry/change-registry-value_0.cmd}
\linej
\lstinputlisting[style=PS,caption=PowerShell script for setting registry entries to 0,captionpos=b]{src/registry/change-registry-value_0.ps1}
\linej
\lstinputlisting[style=PS,caption=CMD script only for executing another PowerShell script,captionpos=b]{src/registry/change-registry-value_1.cmd}
\linej
\lstinputlisting[style=PS,caption=PowerShell script for setting registry entries to 1,captionpos=b]{src/registry/change-registry-value_1.ps1}
\linej
\lstinputlisting[style=PS,caption=CMD script only for executing another PowerShell script,captionpos=b]{src/registry/create-registry-value_1.cmd}
\linej
\lstinputlisting[style=PS,caption=PowerShell script for creating registry entries with value 1,captionpos=b,label={lst:create-registry-value_1}]{src/registry/create-registry-value_1.ps1}
\linej
\lstinputlisting[style=PS,caption=CMD script only for executing another PowerShell script,captionpos=b]{src/registry/delete-registry.cmd}
\linej
\lstinputlisting[style=PS,caption=PowerShell script for deleting registry entries,captionpos=b,label={lst:delete-registry}]{src/registry/delete-registry.ps1}
\linej

\section*{Backup deletion}
\lstinputlisting[style=xml,caption=Sysmon configuration for monitoring vssadmin,captionpos=b,label={lst:vssadmin_sysmon}]{src/sysmon_vssadmin.xml}
\linej
\lstinputlisting[style=xml,caption=Wazuh rules for the detection deletion with vssadmin,captionpos=b,label={lst:vssadmin_rules}]{src/rules_vssadmin.xml}
\linej

\lstinputlisting[style=xml,caption=Remote command configuration in \textit{/var/ossec/etc/shared/default/agent.conf} for the free space script,captionpos=b,label={lst:free_space_wodle}]{src/space_volume/wodle_free_space.xml}
\linej

\lstinputlisting[style=PS,caption=PowerShell script to manage the free space in the backup volume and report in JSON,captionpos=b,label={lst:free_space_ps1_simple}]{src/space_volume/free_space_simple.ps1}
\linej
\lstinputlisting[style=xml,caption=Wazuh rules for processing the output of the free space remote command,captionpos=b,label={lst:free_space_rules_simple}]{src/space_volume/rules_free_space_simple.xml}
\linej

\lstinputlisting[style=PS,caption=PowerShell script to get the free space in the backup volume and parse its output to JSON,captionpos=b,label={lst:free_space_ps1}]{src/space_volume/free_space.ps1}
\linej
\lstinputlisting[style=xml,caption=Configuration in \textit{/var/ossec/etc/ossec.conf} for the free space detection,captionpos=b,label={lst:free_space_ossec_configuration}]{src/space_volume/ossec.conf}
\linej
\lstinputlisting[style=sh,caption=Bash script in \textit{/var/ossec/active-response/bin} to compare the free space value with the previous one and update the storage and log files,captionpos=b,label={lst:free_space_sh}, stringstyle=\color{black}]{src/space_volume/free_space.sh}
\linej
\lstinputlisting[style=xml,caption=Wazuh rules for processing processes for the detection of the increase of the free space,captionpos=b,label={lst:free_space_rules}]{src/space_volume/rules_free_space.xml}
\linej

\section*{Others}
\lstinputlisting[style=xml,caption=Enable Sysmon log forwarding to Wazuh in \textit{/var/ossec/etc/shared/default/agent.conf},captionpos=b,label={lst:forward_sysmon}]{src/forward_sysmon.xml}
\linej
\lstinputlisting[style=xml,caption=Enable PowerShell log forwarding to Wazuh in \textit{/var/ossec/etc/shared/default/agent.conf},captionpos=b,label={lst:forward_powershell}]{src/forward_powershell.xml}
\linej
\lstinputlisting[style=xml,caption=Enable Windows Defender log forwarding to Wazuh in \textit{/var/ossec/etc/shared/default/agent.conf},captionpos=b,label={lst:forward_Windows_Defender}]{src/forward_Windows_Defender.xml}
\linej
