\section{Introduction}
Wazuh is a fork of OSSEC. It adds a RESTFul API, has a more updated ruleset and is easier to install (providing ELK over OSSEC).
\begin{figure}[H]
  \centering
	\includegraphics[width=.6\textwidth]{figuras/wazuh_stack.png}
	\caption{The different parts of Wazuh\cite{wazuh_stack}}
\end{figure}
\linej
The most interesting qualities of Wazuh for this project are\cite{wazuh_index}\cite{wazuh_documentation}: %necessary redundancy
\begin{itemize}
	\item \textbf{Rootkits detection}: Rootkits are commonly used after an attack has succeeded to use the computer of the victim leaving no traces.
	\item \textbf{File integrity monitoring}: It can provide detection of intrusions by identifying changes in content, permissions, ownership, and attributes on the monitored files. It can be used to comply with GDPR (General Data Protection Regulation).
	\item \textbf{Scalability and multi-platform}: This means that the work on this project could really be used in real work environments.
	\item \textbf{Configuration management}: The configuration is managed by the Wazuh server (Wazuh manager) and the agents can be grouped, allowing custom, group or global gathering and detection for each agent.
	\item \textbf{Multiple sources of data}: The scanned data can be from logs, output of commands or databases.
	\item \textbf{Active response}: Automated remediation to security violations and threats, to mitigate more the possible damage. For example to stop the Internet connection to isolate a compromised system.
	\item \textbf{Improved ruleset}: It is the combination of rules and decoders. Having this ruleset out of the box reduces the workload of this project. It can also serve as reference and complement some of the rules and decoders that this project intends to work on.
	\item \textbf{Open source, free and easy to contribute to}: This is optional but nice, as it offers a chance to an inexperienced student to contribute in a real and useful project. The project is hosted on Github and Google Groups. In this project the contribution would be to the ruleset\cite{wazuh_ruleset} and not to the core of Wazuh\cite{wazuh} or the documentation\cite{wazuh_documentation2}.
		%TODO decidir si hacer contribuci√≥n al ruleset y si cambiar/dejar esto y otras menciones similares
\end{itemize}
\linej
The RESTFul API interacts using OSSEC commands and would be interesting if this project were related to a tool issuing queries to Wazuh, but this is not the case. Anyway it is still something valuable to have as these kind of tools are very common nowadays.

\linej
\linej
Wazuh provides support and integration with multiple important tools and technologies:
\begin{itemize}
	\item Docker container for OSSEC: An ossec-server image with the ability to separate the ossec configuration/data from the container.
	\item Puppet and Ansible: For massive deployment. This can be very helpful to setup a big environment mostly because even being no need to put configuration files in the agents for Wazuh often is necessary to configure other things and the process of registering agents can be tedious manually.
	\item Network IDS integration: Gives the option to use OwlH and integrate Suricata and Bro to generate alerts in Wazuh.
	%\item Splunk infrastructure: Comprised of a Splunk Enterprise instance as indexer and a Splunk Forwarder node, as well as the Wazuh app for Splunk.
	\item VirusTotal: A free virus, malware and URL online scanning service that combines more than 40 antivirus solutions.
	\item OSQuery: Osquery can be used to expose an operating system as a high-performance relational database. This allows you to write SQL-based queries to explore operating system data.
\end{itemize}
\linej
The use of these depends on the scenario, but we only take interest in VirusTotal and Network integration. They can work as secondary detection methods for the most critical or complicated cases.

\section{Wazuh architecture}

A basic Wazuh setup has the next components\cite{wazuh_architecture}:
\begin{itemize}
	\item Wazuh server: Runs the Wazuh manager, API and Filebeat (Filebeat is only necessary in distributed architecture). It collects and analyzes data from deployed agents.
	\item ELK stack: It reads, parses, indexes, and stores alert data generated by the Wazuh server. The ELK stack is flexible, highly configurable and very used in big data.
	\item Wazuh agent: Runs on the monitored host, collecting system log and configuration data and detecting intrusions and anomalies. It communicates with the Wazuh server, to which it forwards collected data for further analysis.
\end{itemize}
\linej
The main difference with the architecture of OSSEC is the ELK stack, because OSSEC leaves the choice of tools to the user. ELK stands for the combination of:
\begin{itemize}
	\item Elasticsearch: Gets the data and allows search queries and analysis.
	\item Logstash: Transforms the data to the desired format. This step can make alike data from different log and output formats, trivializing the decoders work.
	\item Kibana: Shows the data in a web browser, with graphs and options like grouping and time interval. This is often easier than to write commands to scan the OSSEC log in the Wazuh server, as the data of interest tends to stay the same.
\end{itemize}
\linej
\label{singlehost}
There are two possible architectures for this setup: having the ELK stack in the same machine that the Wazuh server (single host) or in a separated one (distributed). Each has advantages and disadvantages and in this project we will use the single host because in our case there are no constraints and is easier to set up and is more efficient.
\begin{figure}[H]
  \centering
	\includegraphics[width=\textwidth]{figuras/wazuh_singlehost.png}
	\caption{Single host architecture}
\end{figure}

\begin{figure}[H]
  \centering
	\includegraphics[width=\textwidth]{figuras/wazuh_distributed.png}
	\caption{Distributed architecture}
\end{figure}
\linej
To understand better the communications and data flow in Wazuh we will now get into more detail on the process\cite{wazuh_architecture2}\cite{wazuh_data_flow}.
\linej
\linej
Wazuh agents use the OSSEC message protocol to send collected events to the Wazuh server over port 1514 (UDP or TCP). The Wazuh server then decodes and rule-checks the received events with the analysis engine. Events that trip a rule are augmented with alert data such as rule id and rule name. The Wazuh message protocol uses a 192-bit Blowfish encryption with a full 16-round implementation, or AES encryption with 128 bits per block and 256-bit keys.
\linej
Logstash formats the incoming data and optionally enriches it with GeoIP information before sending it to Elasticsearch (port 9200/TCP). Once the data is indexed into Elasticsearch, Kibana (port 5601/TCP) is used to mine and visualize the information.
\linej
The Wazuh App runs inside Kibana constantly querying the RESTful API (port 55000/TCP on the Wazuh manager) in order to display configuration and status related information of the server and agents, as well to restart agents when desired. This communication is encrypted with TLS and authenticated with username and password.

\begin{figure}[H]
  \centering
	\makebox[\textwidth][c]{\includegraphics[width=1.2\textwidth]{figuras/wazuh_data_flow1.png}}
	\caption{Communications and data flow}
\end{figure}
\linej
Both alerts and non-alert events are stored in files on the Wazuh server in addition to being sent to Elasticsearch. These files can be written in JSON format and/or in plain text format (.log, with no decoded fields but more compact). These files are daily compressed and signed using MD5 and SHA1 checksums.
There is also the option to store the alerts in a database if OSSEC is compiled with database support (for example MySQL or PostgreSQL)\cite{libro_ossec}.

\section{Rules and decoders}
They constitute the main part of this project and they can be used to detect application or system errors, misconfigurations, attempted and/or successful malicious activities, policy violations and a variety of other security and operational issues\cite{wazuh_index}. Wazuh is quite helpful with the features and documentation of the ruleset and in this project the already existing rules and decoders were a great help as examples.
\linej
\linej
Most of the time we forget about the rest of the details of the previous figure, focusing just on the inmediate elements to the ruleset:
\begin{figure}[H]
  \centering
	\includegraphics[width=.4\textwidth]{figuras/wazuh_data_flow1_zoom.png}
\end{figure}
\linej
When an event is received in the manager first it gets decoded. The process of predecoding is very simple and is meant to extract only static information from well-known fi elds of an event.
Decoding is used for extracting the data that is not static. This means later we can make rules that process this information. It can also be useful to differentiate very similar events, to be later processed by different rules.
\begin{figure}[H]
  \centering
	\includegraphics[width=\textwidth]{figuras/Event_Flow.png}
	\caption{Event Flow Diagram}
\end{figure}
\linej
At least a rule in the hierarchy has to be related to the decoder of the event for it to be able to trigger an alert. An Alert is generated if the conditions of the rule are true an the level of the rule is greater than 1.
\linej
When alerts are triggered they are recorded into the log, and also can be stored in a database, send mails and execute commands\cite{libro_ossec}.

\linej
\linej
There are two tipes of rules\cite{libro_ossec}:
\begin{itemize}
	\item \textbf{Atomic}: They are based on simple events, without any correlation. They are by far the most used.
	\item \textbf{Composite}: Those with multiple events. They have a time window and a number of times the rule has to be true before triggering the alert. They can group multiple atomic rules, all of which have to be true for the composite rule to be true.
\end{itemize}
\linej
The level parameter of the rule marks the severity of the alert. These are some examples\cite{libro_ossec}:
\begin{itemize}
	\item 0: Ignored, no action taken. Primarily used to avoid false positives. These rules are scanned before all the others and include events with no security relevance.
	\item 1: They are like 0, but for composite rules. Atomic rules for composite rules need to be of level 1 to be used by composite rules and not generate any alert on their own.
	\item 2: System low priority notifications or status messages that have no security relevance.
	\item 3: Successful/authorized events. Successful login attempts, firewall allow events, etc.
	\item 4: System low priority errors. Errors related to bad configurations or unused devices/applications.
	\item 5: User-generated errors. Missed passwords, denied actions, etc. These messages typically have no security relevance.
	\item 6: Low relevance attacks. Indicate a worm or a virus that provide no threat to the system such as a Windows worm attacking a Linux server. They also include frequently triggered IDS events and common error events.
\end{itemize}
In this project the same level is used for all the rules that are meant to trigger alerts, to keep it simple.

\linej
\linej
Rules can be added in \textit{/var/ossec/etc/rules/} and decoders in \textit{/var/ossec/etc/decoders/} without any issue, but to change the already existing ones in \textit{/var/ossec/ruleset/rules/} or \textit{/var/ossec/ruleset/decoders/} is a bad idea because the next changes in those files from updates would overwrite them.
%The solution is to copy the code (actually only the id is needed) of the existing item to the folder where we can add new ones, make the desired changes add \textit{overwrite=``yes''}\cite{wazuh_custom}.
\linej
\linej
As mentioned before Wazuh adds its own ruleset over the one provided by the OSSEC project. The next table shows about 20\% of the combined ruleset that Wazuh uses, where ``Out of the box'' means that the source was the OSSEC project.
\begin{figure}[H]
  \centering
	\makebox[\textwidth][c]{\includegraphics[width=1.1\textwidth]{figuras/wazuh_ruleset.png}}
	\caption{Portion of the ruleset used by Wazuh\cite{wazuh_ossec_ruleset}}
\end{figure}
\linej
Wazuh provides a way to manually test how an event is decoded and if an alert is generated with the tool \textit{/var/ossec/bin/ossec-logtest}\cite{wazuh_testing}, which is very useful for debugging.
To use it you only need to introduce the data as it would be received by the Wazuh manager.
Is possible to show which rules are tried and which trigger an alert for each event.
This tools does not need a restart of the wazuh-manager service whenever changes want to be tested because it reads the configuration directly.
\linej
But is also worth to mention that some times it can be misleading because it does not work in the same way as the manager.
For example the logtest may show that the log matches a certain rule but actually it has matched a previous one silently.
\linej
\linej
For example for this input:
\linej
\includegraphics[width=\textwidth]{figuras/ossec-logtest_input.png}
\linej
We get the next output:
\begin{figure}[H]
  \centering
	\includegraphics[width=\textwidth]{figuras/ossec-logtest_output.png}
	\caption{Example of output for ossec-logtest}
\end{figure}
\linej
%TODO cambiar currently in version
After version 3.0.0 (we are currently in 3.9) Wazuh incorporates an integrated decoder for JSON logs enabling the extraction of data from any source in this format. This can be very useful in many situations, for example trivializing the generation of alerts for programs reporting in JSON, without the need for a decoder for each one\cite{wazuh_json}.
\linej
\linej
Another interesting feature is to check if a field extracted during the decoding phase is in a CDB list (constant database). The main use case of this feature is to create a white/black list of users, IPs or domain names.\cite{wazuh_cdb}.
